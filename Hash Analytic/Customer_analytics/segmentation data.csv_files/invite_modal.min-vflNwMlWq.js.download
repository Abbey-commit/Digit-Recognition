define(["require","exports","tslib","react","spectrum/button/index","dig-components/buttons","spectrum/modal/index","modules/clean/deprecated_ajax/ajax_jquery","modules/clean/teams/constants","modules/clean/teams/admin/widgets/open_team_join_onboarding_modal/open_team_join_onboarding_modal","modules/clean/analytics","modules/clean/components/loading_indicator","modules/clean/contacts/contact","modules/clean/contacts/tokenizer","modules/clean/contacts/types","modules/clean/dbmodal_stack","react-modal","modules/clean/loggers/join_flow_logger","modules/clean/react/payments/update_individual_billing/update_individual_store_creator","modules/clean/react/growth/first_task/first_task","modules/clean/payments/skus/subscription_diff","modules/clean/payments/skus/subscription_service","modules/clean/teams/admin/widgets/open_team_join_onboarding_modal/constants","modules/clean/payments/skus/subscription_status","modules/clean/teams/admin/widgets/update_billing_modal/update_billing_modal_loader","modules/clean/react/css","modules/clean/react/invite/invite_and_buy_text","modules/clean/react/invite/available_licenses_text","modules/clean/react/modal","modules/clean/stormcrow/experiment","modules/clean/viewer","modules/core/browser","modules/core/browser_detection","modules/core/html","modules/core/i18n","modules/core/notify","modules/clean/user_education/user_education_client","lodash","modules/clean/metrics/index","modules/clean/ux_analytics_modal_tracking","modules/clean/ux_analytics/utils","modules/clean/react/payments/common/adapters/setup_cash","modules/clean/teams/admin/widgets/invite_modal/invite_link","modules/clean/teams/admin/widgets/invite_modal/invite_modal_constants","modules/clean/teams/admin/api/admin_console_api_client","modules/clean/teams/admin/widgets/invite_modal/invite_modal_first_task/invite_modal_first_task","modules/clean/react/member_sidebar_actions","modules/clean/growth/smb_funnel/smb_funnel_logger","modules/clean/react/admin/teams/onboarding/web/constants","modules/clean/api_v2/user_client","modules/clean/teams/admin/widgets/invite_modal/suggested_members","modules/clean/contacts/async_contact_validation","modules/clean/teams/admin/widgets/invite_modal/invite_validation_message","modules/clean/teams/admin/widgets/import_contacts_modal/import_contacts_modal","modules/clean/teams/admin/widgets/invite_modal/import_contacts_link","dig-components/snackbar","modules/clean/react/snackbar","dig-components/icons","dig-components/icons/src","modules/core/uri","modules/clean/teams/admin/widgets/invite_modal/invitability_state"],(function(e,t,i,n,s,a,o,r,l,c,d,m,u,g,_,v,p,f,b,h,I,M,L,S,y,T,C,E,k,A,w,x,R,O,N,P,V,F,D,B,W,U,q,j,z,J,G,H,X,K,Q,Y,Z,$,ee,te,ie,ne,se,ae,oe){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.InviteModal=t.InviteModalView=t.getUpdateSubChangePlanError=void 0,n=i.__importDefault(n),r=i.__importStar(r),_=i.__importDefault(_),p=i.__importDefault(p),x=i.__importStar(x),R=i.__importStar(R),F=i.__importStar(F),z=i.__importDefault(z);t.getUpdateSubChangePlanError=function(e){return 0===e?j.NO_AVAILABLE_LICENSES_ERROR:(function(e){return N.intl.formatMessage({id:"J/4DT7",defaultMessage:"{count, plural, one{Can only send {count} invite.} other{Can only send {count} invites.}} Ask a team admin to add licenses."},{count:e})})(e)},p.default.setAppElement(document.body);var re=(function(e){function p(o){var c=e.call(this,o)||this;if(c._isMounted=!1,c.logTTI=F.once((function(){c.componentTTITimer.record()})),c.closeModal=function(e){var t=c.props.onDismiss;window.setTimeout((function(){V.UEClient.sendEvent("InviteModal","Hide")}),2500),t?null==t||t(c.state.memberList):k.Modal.close(),e&&e(c.state.memberList),c.state.sentEmails.length&&window.setTimeout((function(){h.showClinkTooltip(h.TooltipType.Members)}),0)},c.onBillingClick=function(e){e.stopPropagation(),e.preventDefault();var s=c.state,a=s.emails,o=s.inviteMessage,r=function(){k.Modal.showInstance(n.default.createElement(t.InviteModal,i.__assign({},c.props,{emails:a,inviteMessage:o,onDismiss:void 0}))),v.DBModalStack.unregister(b.BILLING_INFO_UPDATED,r)};c.closeModal(),v.DBModalStack.register(b.BILLING_INFO_UPDATED,r),y.UpdateBillingModalLoader.showInstance(r)},c.launchImportModal=function(e){var s=c.state,a=s.contacts,o=s.emails,r=s.inviteMessage;k.Modal.showInstance(n.default.createElement($.ImportContactsModal,{preselectedContacts:a,isDisabled:e,onClose:function(){k.Modal.showInstance(n.default.createElement(t.InviteModal,i.__assign({},c.props,{preLoadedContacts:a,emails:o,inviteMessage:r})))},onConfirmSelection:function(e,s){for(var a=i.__spreadArrays(e,s),o=e.filter((function(e){return e.email})).map((function(e){return e.email})),l=o,d=0,m=s;d<m.length;d++){var u=m[d];u.email&&l.push(u.email)}k.Modal.showInstance(n.default.createElement(t.InviteModal,i.__assign({},c.props,{preLoadedContacts:a,emails:l,inviteMessage:r,importedDomainContacts:o})))},width:j.inviteModalWidth}))},c.onSubServiceResponse=function(e,t,i,n){var s=c.props.shouldAsyncValidateEmails,a=c.getInviteCount(s?void 0:t);c.setState({emails:t,isMakingTransitionInfoRequest:!1,isPreparingForSubmit:!1,numRemainingLicenses:c.getRemainingLicensesCount(i,n,a)}),!0===s?e&&c.setState({subChangePlan:e}):c.setState({subChangePlan:e})},c.onContactsChanged=function(e,n){var s=c.state,a=s.isReseller,o=s.isSelfServe,r=s.numProvisionedLicenses,l=s.isLoading,d=s.emails,m=s.sentEmails,u=s.isMakingTransitionInfoRequest,g=c.props.shouldAsyncValidateEmails;if(!l){c.setState({isEmailTextInputted:e.length>0||n.length>0,contacts:e});var _=e.map((function(e){return e.email})).filter((function(e){return void 0!==e})),v=t.InviteModal.countValidAndNonReinviteContacts(e),p=g?v:_.length,f=c.totalLicenses,b={emails:_,isPreparingForSubmit:!1,numRemainingLicenses:c.getRemainingLicensesCount(f,r,p,m.length)},h=p+r;(!0===g?c.isAsyncValidationDone(e):_.length!==d.length)&&!a&&o&&h>f?c.updateSubChangePlan(h,i.__assign(i.__assign({},b),{totalLicenses:f,numProvisionedLicenses:r})):c.setState(i.__assign(i.__assign({},b),{isMakingTransitionInfoRequest:!(h<=f)&&u}))}},c.onMessageChanged=function(e){c.setState({inviteMessage:e.target.value})},c.sendInviteAction=function(){if(c.contactsTokenizer){var e=c.state.emails,t=c.contactsTokenizer.getContacts();e.length!==t.length?c.setState({isPreparingForSubmit:!0},(function(){c.contactsTokenizer.tokenizeAll()})):c.sendMemberInvites()}else c.sendMemberInvites()},c.onPrimaryActionClick=function(){if(c.props.onPrimaryAction){var e=c.state,t=e.numRemainingLicenses,i=e.subChangePlan,n={charge_for_new_licenses:!0,expected_overage:String(t<0?-1*t:0),expected_price:"0"};return i&&i.tvm&&(n.expected_price=i.tvm.transition.expected_price),c.props.onPrimaryAction(n),void k.Modal.close()}!c.showInviteLink()&&!c.props.isAfterLicenseReclaim||c.props.isFirstTask?c.sendInviteAction():c.shouldRenderSendInviteAction?c.sendInviteAction():c.closeModal()},c.onSecondaryActionClick=function(){var e=c.state,n=e.contacts,s=e.emails,a=e.suggestedMembers,o=e.suggestedMembersSuggestId,r=e.numRemainingLicenses,l=c.props.shouldAsyncValidateEmails?t.InviteModal.countReinviteContacts(n):0,m=i.__assign(i.__assign({},c.defaultLoggingExtras),{added_message:c.hasInviteMessage,invite_count:c.getInviteCount()+l,invite_or_buy:c.inviteOrBuyText});if(a&&a.length){var u=F.filter(a,(function(e){return-1!==s.indexOf(e.email)}));m.total_recommendations=a.length,m.num_selected_recommendations=u.length,m.suggest_id=o,m.num_licenses_available=r}d.TeamsWebActionsLogger.log("invite_member_open_cancel",m),c.closeModal()},c.logSmbFunnel=function(e,t){void 0===t&&(t={});var n=c.props.isFirstTask,s=c.props.isMobileWeb;(n||s)&&H.SMBFunnelLogger.log(e,i.__assign(i.__assign({},t),{first_task:String(n),mv_invites:String(s)}))},c.sendMemberInvites=function(){var e=c.state,s=e.contacts,o=e.emails,m=e.groupIds,u=e.inviteMessage,g=e.numRemainingLicenses,_=e.subChangePlan,v=e.sentEmails,p=e.memberList,b=e.suggestedMembers,h=e.userOrientedAccessEnabled,I=c.props,M=I.shouldAsyncValidateEmails,S=I.shouldSkipInvalidInvitees,y=I.importedDomainContacts,T=I.isFromIMMOnMembersPage,C=g<0?-1*g:0,E={charge_for_new_licenses:!0,custom_message:u,emails:o,group_ids:m,expected_overage:String(C),expected_price:"0",extra:JSON.stringify(i.__assign({},c.defaultLoggingExtras)),url:x.get_uri().path,invite_source:f.InviteSource.IMM_WEB,platform:f.Platform.WEB,skip_invalid_invitees:Boolean(S),poll_events_on_commit:!1,is_from_IMM_members_page:void 0!==T&&T},k=function(e){var t=e.title,i=e.numOfInvitedUsers,s=e.adminId,o=e.userEmail,r={uoa_source:"IMM",selected_member_email:o},l=n.default.useState(!0),d=l[0],m=l[1];return n.default.createElement("div",{className:"invite-modal__snack-bar"},n.default.createElement(te.Snackbar,{open:d,onRequestClose:function(){m(!1)},timeout:15e3},n.default.createElement(ne.UIIcon,{src:se.CheckmarkCircleLine}),n.default.createElement(te.Snackbar.Message,null,t),n.default.createElement(te.Snackbar.Actions,null,n.default.createElement(a.Button,{variant:"transparent",inverse:!0,onClick:function(){c.logUOASnackbar("uoa_imm_click_manage_access",s,i,o),x.redirect(new ae.URI({path:"/team/admin/content/home",query:r,fragment:"member_access"}).toString())}},N.intl.formatMessage({id:"qG3VMJ",defaultMessage:"Manage access"})))))};_&&_.tvm&&(E.expected_price=_.tvm.transition.expected_price);var A=M?t.InviteModal.countReinviteContacts(s):0;if(d.TeamsWebActionsLogger.log("invite_member_open_invite_click",i.__assign(i.__assign({},c.defaultLoggingExtras),{added_message:c.hasInviteMessage,expected_price:E.expected_price,invite_count:c.getInviteCount()+A,invite_or_buy:c.inviteOrBuyText,licenses_to_add:C,group_ids:m,imported_contact_count:y?y.length:0})),0===c.getInviteCount()&&(!M||0===t.InviteModal.countReinviteContacts(s)))return P.Notify.error(N.intl.formatMessage({id:"E/vNT2",defaultMessage:"You havenâ€™t included anyone to invite! Please invite at least one person."})),void d.TeamsWebActionsLogger.log("invite_member_open_invite_error",i.__assign(i.__assign({},c.defaultLoggingExtras),{client:!0,error_reason:"no_invites",invite_or_buy:c.inviteOrBuyText,group_ids:m}));for(var R=0,V=o;R<V.length;R++){var D=V[R].toLowerCase().split("@",2)[1];if(-1!==["getdropbox.com","dropboxmail.com"].indexOf(D))return P.Notify.error(N.intl.formatMessage({id:"ffW3Dm",defaultMessage:"You are not allowed to invite a member with a {domain} email."},{domain:D})),void d.TeamsWebActionsLogger.log("invite_member_open_invite_error",i.__assign(i.__assign({},c.defaultLoggingExtras),{client:!0,error_reason:"invite with dropbox domain",invite_or_buy:c.inviteOrBuyText,group_ids:m}))}c.props.shouldNotToastOnSuccess||P.Notify.success(N.intl.formatMessage({id:"uBRRiV",defaultMessage:"Submitting..."})),c.setState({isSubmitting:!0},(function(){var e=Date.now(),s=w.Viewer.get_viewer().work_user,a=c.state.contacts,u=M?t.InviteModal.countReinviteContacts(a):0,_={invite_source:f.InviteSource.IMM_WEB,added_message:c.hasInviteMessage,invite_count:c.getInviteCount()+u,invite_or_buy:c.inviteOrBuyText,expected_price:E.expected_price,licenses_to_add:C};r.FormWebRequest({url:"/account/team/add_users",data:E,subject_user:s,success:function(t){var a=JSON.parse(t);if(P.Notify.clear(),c.setState({isSubmitting:!1}),d.TeamsWebActionsLogger.log("team_admin_add_member_submit_time",i.__assign(i.__assign(i.__assign({},c.defaultLoggingExtras),{time_ms:Date.now()-e}),_)),a){var f=a.users,I=a.has_invalid_invites,S=Object.keys(f),T=S.length,C=S.map((function(e){return f[e].email})),E=o.filter((function(e){return-1===C.indexOf(e)})).length,A=a.show_open_team_join_onboarding_modal,w=a.team_domains;if(p.length&&c.props.isFirstTask&&!I){var x=p[0],R=p.slice(1),O=S.map((function(e){return{admin_role:l.ADMIN_ROLE.NONE,initials:f[e].email[0].toUpperCase(),photo_url:null,display_name:f[e].email,email:f[e].email,team_join_state:G.JoinState.PENDING,user_id:f[e].id}}));c.setState({numRemainingLicenses:g-v.length,sentEmails:v.concat(O),emails:[],memberList:i.__spreadArrays([x],O,R)},c.closeModal)}else c.props.onInviteSuccess&&c.props.onInviteSuccess(a.num_invited,g<0?-1*g:0),!0===I?c.removeInvitedContactsAfterInvites(C):A?(c.closeModal(),c.openOpenTeamJoinOnboardingModal(L.OpenTeamJoinUserAction.ONBOARDING_MODAL_VIEW_AFTER_INVITE,w)):c.closeModal();var V=!0===M?{valid_invite_count:T}:void 0;if(d.TeamsWebActionsLogger.log("invite_member_open_invite_success",i.__assign(i.__assign(i.__assign({},c.defaultLoggingExtras),{added_message:c.hasInviteMessage,invite_count:c.getInviteCount()+u,invite_or_buy:c.inviteOrBuyText,members_length:p.length,group_ids:m}),V)),c.logSmbFunnel(X.AMPMetrics.ACTIVATION_IMM_ADD_MEMBERS,{success:"true",numInvited:String(T),membersLength:String(p.length)}),c.props.showTeammateSuggestions&&b&&b.length)for(var D=0,B=F.filter(b,(function(e){return-1!==o.indexOf(e.email)}));D<B.length;D++){var W=B[D];d.TeamsWebActionsLogger.log("admin_invite_recommended_contact",{user_id:W.user_id,team_type:W.team_type,prediction_id:W.prediction_id,num_licenses_available:g,origin:"imm_recommendation",inviteModal:!0})}if(y){var U=y.filter((function(e){return C.includes(e)}));d.TeamsWebActionsLogger.log("google_directory_invited_contacts",{num_invited:U.length,contacts:U,num_licenses_available:g},void 0,void 0,!0),d.TeamsWebActionsLogger.log("google_directory_invited_contacts",{num_invited:U.length,num_licenses_available:g})}if(!0===I)0===T?P.Notify.error(N.intl.formatMessage({id:"LYHTOV",defaultMessage:"Invites couldn't be sent. Fix any issues, and try sending them again."})):P.Notify.warning(N.intl.formatMessage({id:"OtZGgm",defaultMessage:"Some invites sent. {count, plural, one{Fix any issues, and try the last {count} again.} other {Fix any issues, and try the last {count} again.}}"},{count:E}));else if(!c.props.shouldNotToastOnSuccess){var q=void 0;1===T?(q=N.intl.formatMessage({id:"klqzm6",defaultMessage:"Invited {user_email}."},{user_email:f[S[0]].email}),h&&!c.props.isFirstTask?(ie.Snackbar.show(n.default.createElement(k,{title:q,numOfInvitedUsers:T,adminId:s.id,userEmail:f[S[0]].email})),c.logUOASnackbar("uoa_imm_snackbar_shown",s.id,T,f[S[0]].email)):P.Notify.success(q)):T>1?(q=N.intl.formatMessage({id:"A+luT2",defaultMessage:"Invited {user_count} people."},{user_count:T}),h&&!c.props.isFirstTask?(ie.Snackbar.show(n.default.createElement(k,{title:q,numOfInvitedUsers:T,adminId:s.id,userEmail:f[S[0]].email})),c.logUOASnackbar("uoa_imm_snackbar_shown",s.id,T,f[S[0]].email)):P.Notify.success(q)):P.Notify.error(N.intl.formatMessage({id:"9fLrh/",defaultMessage:"{count, plural, one{Skipped {count} person who is already a member of the team.} other{Skipped {count} people who are already members of the team.}}"},{count:E}))}r.SilentBackgroundRequest({url:"/account/team/ajax_log_invites",data:{invitations:T}})}else c.props.onInviteError&&c.props.onInviteError(),P.Notify.error(N.intl.formatMessage({id:"bLA3rA",defaultMessage:"There was a problem completing this request."})),c.logSmbFunnel(X.AMPMetrics.ACTIVATION_IMM_ADD_MEMBERS,{success:"false",errorReason:"response_empty"})},error:function(t,n,s){P.Notify.clear(),c.setState({isSubmitting:!1}),d.TeamsWebActionsLogger.log("team_admin_add_member_submit_time",i.__assign(i.__assign(i.__assign({},c.defaultLoggingExtras),{time_ms:Date.now()-e,error:!0}),_)),c.logSmbFunnel(X.AMPMetrics.ACTIVATION_IMM_ADD_MEMBERS,{success:"false",errorReason:"request_error"});var a=N.intl.formatMessage({id:"/GekxI",defaultMessage:"There was a problem completing this request."});if(s)try{var o=JSON.parse(s).emails,r=void 0===o?{}:o;if(r.message_text){a=r.message_text;var l=i.__assign({err_msg:a.replace(j.EMAIL_REGEX,"***")},c.defaultLoggingExtras);d.TeamsWebActionsLogger.log("invite_member_open_invite_error",i.__assign(i.__assign({},l),{client:!0,error_reason:"form_input_invalid",invite_or_buy:c.inviteOrBuyText,group_ids:m}))}}catch(e){a=s}else d.TeamsWebActionsLogger.log("invite_member_open_invite_error",i.__assign(i.__assign({},c.defaultLoggingExtras),{client:!0,error_reason:"problem_request",invite_or_buy:c.inviteOrBuyText,group_ids:m}));c.props.onInviteError&&c.props.onInviteError(),P.Notify.error(new O.HTML(a))}})}))},c.isAsyncValidationDone=function(e){for(var t=0,i=e;t<i.length;t++){var n=i[t];if(void 0===n.invitability_state&&!0!==n.invalid)return!1}return!0},c.renderPrimaryAction=function(e,i){var a=c.state,o=a.isReseller,r=a.numRemainingLicenses,l=a.isSubmitting,d=a.isSelfServe,u=a.memberList,g=a.isJustInTimeLicensingEnabled,_=c.props,v=_.getPrimaryButtonText,p=_.isFirstTask,f=c.isInviteButtonDisabled,b=N.intl.formatMessage({id:"yzFoXG",defaultMessage:"Send invites"});if(r<0&&!o&&!c.isNCCT&&d&&!u.length&&(b=N.intl.formatMessage({id:"dljqTf",defaultMessage:"Invite and buy"})),g||p){var h=c.state.contacts;b=N.intl.formatMessage({id:"L7+s23",defaultMessage:"{count, plural, one{Invite member} other{Invite members}}"},{count:c.getInviteCount()+t.InviteModal.countReinviteContacts(h)})}return v&&(b=v(g)),!c.showInviteLink()&&!c.props.isAfterLicenseReclaim||c.shouldRenderSendInviteAction||p||(b=N.intl.formatMessage({id:"XEaqiT",defaultMessage:"Done"}),f=!1),n.default.createElement(s.Button,{className:"invite-modal__send-invites",ref:i,variant:"primary",disabled:f,onClick:e},n.default.createElement("span",{className:"modal-button-wrapper"},b,l&&n.default.createElement("span",{className:"loading-indicator"},n.default.createElement(m.LoadingIndicator,{style:m.LoadingIndicator.LoadingIndicatorStyle.SPINNER}))))},c.renderSecondaryAction=function(e){var t=N.intl.formatMessage({id:"d9/SE1",defaultMessage:"Cancel"});return n.default.createElement(s.Button,{variant:"secondary",onClick:e},t)},c.contactFilter=function(e){return e.type===_.default.EMAIL&&!e.on_team},c.renderContactsTokenizer=function(e,t,i){if(void 0===t&&(t=N.intl.formatMessage({id:"Le5Iez",defaultMessage:"Name or email"})),void 0===i&&(i=8),e){var s,a=c.state,o=a.isLoading,r=a.contacts,l=a.emails,d=a.validatedContactMap,m=c.props.shouldAsyncValidateEmails;s=l.map((function(e){return new u.Contact({name:e,email:e,type:_.default.EMAIL,invalid:!1,on_team:!1,pending:!0,query:e})}));var v=m?n.default.createElement(Z.InviteValidationMessage,{contacts:r}):null;return n.default.createElement("div",{className:"invite-modal__tokenizer"},n.default.createElement(g.ContactsTokenizer,{customClass:o?"disabled":"",customContactFilter:c.contactFilter,disabled:o,onContentsChange:c.onContactsChanged,placeholder:t,populatedInputData:{tokens:!0===m?r:s,value:""},ref:function(e){c.contactsTokenizer=e},showContactImport:!1,tokenSpacing:i,user:e,listHeight:81,tokenizeOnOutOfFocus:!0,asyncValidateContacts:!0===m?c.asyncEmailsValidation:void 0,customContactValidator:!0===m?c.contactValidator:void 0,validatedContactMap:!0===m?d:void 0}),v)}},c.checkboxCallback=function(e,t){var n=c.state,s=n.emails,a=n.isReseller,o=n.numProvisionedLicenses,r=n.sentEmails,l=n.suggestedMembers,m=n.numRemainingLicenses,g=n.contacts,v=n.isMakingTransitionInfoRequest,p=c.props.shouldAsyncValidateEmails,f=F.find(l,(function(e){return e.email===t})),b=s.slice(),h=g.slice();if(e){b.push(t);var I=new u.Contact({name:t,email:t,type:_.default.EMAIL,invalid:!1,on_team:!1,pending:!0,query:t});h.push(I),!0===p&&Promise.resolve(c.asyncEmailsValidation([I])),d.TeamsWebActionsLogger.log("admin_select_recommended_contact",{user_id:f.user_id,team_type:f.team_type,prediction_id:f.prediction_id,num_licenses_available:m,origin:"imm_recommendation"})}else b=b.filter((function(e){return e!==t})),h=h.filter((function(e){return e.email!==t})),d.TeamsWebActionsLogger.log("admin_deselect_recommended_contact",{user_id:f.user_id,team_type:f.team_type,prediction_id:f.prediction_id,num_licenses_available:m,origin:"imm_recommendation"});c.setState({isEmailTextInputted:b.length>0,emails:b,contacts:h});var M={emails:b,isPreparingForSubmit:!1,numRemainingLicenses:c.getRemainingLicensesCount(c.totalLicenses,o,b.length,r.length)},L=b.length+o;!a&&L>c.totalLicenses&&!p?c.updateSubChangePlan(L,i.__assign(i.__assign({},M),{totalLicenses:c.totalLicenses,numProvisionedLicenses:o})):c.setState(i.__assign(i.__assign({},M),{isMakingTransitionInfoRequest:!(L<=c.totalLicenses)&&v}))},c.closeAndOpenCSVImportModal=function(){var e=c.props,t=e.onCSVImport,i=e.onDismiss;d.TeamsWebActionsLogger.log("import_csv_modal_open",c.defaultLoggingExtras),t&&(c.closeModal(i),t())},c.showInviteLink=function(){return c.state.doesUserHavePermissionsToManageInviteLink&&c.props.shouldShowInviteLink&&!c.state.isEmailTextInputted},c.contactValidator=function(e){return t.InviteModal.isContactInvalid(e)?{state:g.ContactTokenState.invalid,msg:j.InvitabilityWarnings.get(e.invitability_state||"")||j.INVALID_TOOLTIP}:{state:g.ContactTokenState.ok,msg:null}},c.asyncEmailsValidation=function(e){return i.__awaiter(c,void 0,Promise,(function(){var t,n;return i.__generator(this,(function(s){switch(s.label){case 0:return[4,Y.asyncInviteeEmailsValidation(e)];case 1:return t=s.sent(),!0===this._isMounted&&(n=this.state.validatedContactMap,this.setState({validatedContactMap:new Map(i.__spreadArrays(Array.from(n),Array.from(t)))})),[2]}}))}))},c.componentTTITimer=D.getMetricsReporter().createTimer({ns:j.AMP_INVITE_MODAL_NAMESPACE_NAME,name:j.AMP_INVITE_MODAL_TTI_METRIC_NAME}),c.subService=new M.SubscriptionService,c.apiClient=new z.default,c.state={emails:o.emails||[],groupIds:[],inviteMessage:o.inviteMessage||"",isEmailTextInputted:!!o.emails&&o.emails.length>0||!1,isLoading:!0,isMakingTransitionInfoRequest:!1,isPreparingForSubmit:!1,isSubmitting:!1,numProvisionedLicenses:0,numRemainingLicenses:0,showInviteLink:!1,showSidebar:!!o.memberList&&1===o.memberList.length&&!o.isMobileWeb,memberList:o.memberList||[],sentEmails:[],isJustInTimeLicensingEnabled:!1,contacts:o.preLoadedContacts||[],validatedContactMap:new Map,doesUserHavePermissionsToManageInviteLink:!1,ncctVariant:""},Promise.resolve(c.asyncEmailsValidation(c.state.contacts)),c.defaultLoggingExtras={is_client:!1,origin:c.props.origin},c.props.actionTrigger){c.defaultLoggingExtras.action_trigger=c.props.actionTrigger,c.defaultLoggingExtras.module_name="first_task_imm",c.defaultLoggingExtras.framework="team_setup_essential",c.defaultLoggingExtras.mobile_web=R.is_supported_mobile_browser();var p=c.defaultLoggingExtras.mobile_web?H.Platform.MOBILE_WEB:H.Platform.WEB;H.SMBFunnelLogger.setCommonTags({platform:p})}return c}return i.__extends(p,e),Object.defineProperty(p.prototype,"isInviteButtonDisabled",{get:function(){var e=this.state,i=e.contacts,n=e.isLoading,s=e.isMakingTransitionInfoRequest,a=e.isReseller,o=e.isSelfServe,r=e.isSubmitting,l=e.numRemainingLicenses;return n||s||r||a&&l<0||!o&&l<0||0===this.getInviteCount()&&(!this.props.shouldAsyncValidateEmails||0===t.InviteModal.countReinviteContacts(i))&&this.contactsTokenizer&&0===this.contactsTokenizer.getInputValue().length},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"hasInviteMessage",{get:function(){return Boolean(this.state.inviteMessage)},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"inviteOrBuyText",{get:function(){return this.state.numRemainingLicenses<0?"invite_buy":"send_invites"},enumerable:!1,configurable:!0}),p.prototype.relaunchFirstTaskModal=function(e){var t=this.props.onDismiss;t&&t(e,!0)},p.prototype.componentDidUpdate=function(e,t){var i=this.state,n=i.isPreparingForSubmit,s=i.numRemainingLicenses;!1===i.isLoading&&!0===t.isLoading&&(this.props.logTTIOnLoaded?this.props.logTTIOnLoaded():this.logTTI()),s>=this.getInviteCount()&&t.isPreparingForSubmit&&!n&&this.sendMemberInvites()},p.prototype.componentWillUnmount=function(){this._isMounted=!1,W.dispatchModalClosed()},p.prototype.componentDidMount=function(){this._isMounted=!0,this.fetchViewModel()},p.prototype.fetchViewModel=function(){var e=this,t=this.props.onDismiss;r.WebRequest({url:"/team/admin/members/invite_members_modal_view_model",subject_user:w.Viewer.get_viewer().work_user,success:function(t){var n,s,a=JSON.parse(t),o=a.isReseller,r=a.numActiveTeamMembers,l=a.provisionedLicenses,c=a.currencyToFormatMap,m=a.localeNumberFormat,u=a.isJustInTimeLicensingEnabled,g=a.doesUserHavePermissionsToManageInviteLink,_=a.userOrientedAccessEnabled,v=a.ncctVariant,p=void 0===a.isSelfServe||a.isSelfServe;if(e.setState({numActiveTeamMembers:r,numProvisionedLicenses:l,isJustInTimeLicensingEnabled:u,doesUserHavePermissionsToManageInviteLink:g,isReseller:o,isSelfServe:p,userOrientedAccessEnabled:Boolean(_),ncctVariant:v}),o){var f=a.resellerContact,b=a.serializedResellerSubSkuSet;s=b.licenseSkus[0].quantity,n=e.getRemainingLicensesCount(s,l),e.setState({isLoading:!1,numRemainingLicenses:n,resellerContact:f,serializedResellerSubSkuSet:b},(function(){var t;e.showInviteLink()&&(t=e.props.inviteLinkUrl?"ON":"OFF"),d.TeamsWebActionsLogger.log("invite_member_open",i.__assign(i.__assign({},e.defaultLoggingExtras),{invite_or_buy:e.inviteOrBuyText,license_limit:s,num_team_members:r,provisioned_licenses:l,url:x.get_uri().path,link_status:t})),e.setInitialSubChangePlan()}))}else{var h=S.SubscriptionStatus.deserialize(a.serializedSubStatus),I=e.props.isIMMOverageFixOn;s=!0===I?h.subState.totalUsableLicenses:h.subState.totalLicenses,n=e.getRemainingLicensesCount(s,l,e.getInviteCount(),e.state.sentEmails.length),e.props.showTeammateSuggestions&&e.fetchSuggestions(),e.setState({numRemainingLicenses:n,subStatus:h},(function(){var t;e.showInviteLink()&&(t=e.props.inviteLinkUrl?"ON":"OFF"),d.TeamsWebActionsLogger.log("invite_member_open",i.__assign(i.__assign({},e.defaultLoggingExtras),{invite_or_buy:e.inviteOrBuyText,license_limit:s,num_team_members:r,provisioned_licenses:l,url:x.get_uri().path,link_status:t})),e.setInitialSubChangePlan()}))}U.setupCash(m,c),W.dispatchModalOpened()},error:function(i){P.Notify.error(N.intl.formatMessage({id:"C2BKnZ",defaultMessage:"Failed to load modal."})),e.closeModal(t)}})},p.prototype.getRemainingLicensesCount=function(e,t,i,n){return void 0===i&&(i=0),void 0===n&&(n=0),e-t-i-n},Object.defineProperty(p.prototype,"totalLicenses",{get:function(){var e=this.state,t=e.isReseller,i=e.serializedResellerSubSkuSet,n=e.subStatus;return t?i.licenseSkus[0].quantity:n?!0===this.props.isIMMOverageFixOn?n.subState.totalUsableLicenses:n.subState.totalLicenses:void 0},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"viewer",{get:function(){return w.Viewer.get_viewer()},enumerable:!1,configurable:!0}),p.prototype.openOpenTeamJoinOnboardingModal=function(e,t){if(t&&t.length){var i=this.viewer.work_user.id;k.Modal.showInstance(n.default.createElement(c.OpenTeamJoinOnboardingModal,{domains:t,userId:i,userActionToTrack:e}))}},p.prototype.setInitialSubChangePlan=function(){var e=this.props.emails,t=this.state.numProvisionedLicenses,i=this.getInviteCount();i+t>this.totalLicenses?this.updateSubChangePlan(i+t,{emails:e,numProvisionedLicenses:t,totalLicenses:this.totalLicenses},{isLoading:!1}):this.setState({isLoading:!1,isMakingTransitionInfoRequest:!1})},p.prototype.updateSubChangePlan=function(e,n,s){var a=this;void 0===s&&(s={});var o=n.emails,r=n.totalLicenses,l=n.numProvisionedLicenses,c=I.SubscriptionDiff.fromSubscriptionStatus(this.state.subStatus);c.setTotalLicenses(e),this.setState({isMakingTransitionInfoRequest:!0},(function(){var e=Date.now();a.subService.price(c).then((function(t){a.onSubServiceResponse(t,o,r,l),F.isEmpty(s)||a.setState(s),d.TeamsWebActionsLogger.log("invite_member_billing_load_time_new_imm",i.__assign(i.__assign({},a.defaultLoggingExtras),{time_ms:Date.now()-e}))})).catch((function(e){if(!1!==a.props.canChangeTeamBilling)throw e;var i=r-l;P.Notify.error(t.getUpdateSubChangePlanError(i))}))}))},p.prototype.logUOASnackbar=function(e,t,i,n){d.TeamsWebActionsLogger.log(e,{admin_id:t,invite_count:i}),d.TeamsWebActionsLogger.log(e,{admin_id:t,invite_count:i,invitee_email:n},void 0,t,!0)},p.prototype.removeInvitedContactsAfterInvites=function(e){var t=this.state,i=t.contacts,n=t.emails,s=i.filter((function(t){return t.email&&!e.includes(t.email)})),a=n.filter((function(t){return!e.includes(t)}));this.setState({contacts:s,emails:a,isLoading:!0}),this.fetchViewModel()},Object.defineProperty(p.prototype,"shouldRenderSendInviteAction",{get:function(){return this.state.isEmailTextInputted},enumerable:!1,configurable:!0}),p.prototype.renderAltAction=function(){var e=this.state.numRemainingLicenses;return!this.isNCCT&&e&&e<0?this.renderPricingInformation():null},p.prototype.renderForm=function(){var e=this.state,t=e.inviteMessage,i=e.isLoading,s=e.isEmailTextInputted,a=e.emails,o=e.suggestedMembers,r=this.props.showTeammateSuggestions&&o&&!!o.length,l=this.showInviteLink(),c=!r&&!l||s,d=N.intl.formatMessage({id:"KM5lP0",defaultMessage:"Or invite with an email"});return n.default.createElement("form",{className:"invite-modal__form"},l&&n.default.createElement("p",{className:"invite-modal__form_title"},d),this.renderContactsTokenizer(this.viewer.work_user),c&&n.default.createElement("div",null,n.default.createElement("textarea",{className:"invite-modal__message-input",disabled:i,id:"message-input",onChange:this.onMessageChanged,placeholder:N.intl.formatMessage({id:"D4+6Xw",defaultMessage:"Add an optional message"}),value:t}),n.default.createElement("label",{className:"message-input-label",htmlFor:"message-input"},N.intl.formatMessage({id:"N6BsJQ",defaultMessage:"Invite message"}))),r&&n.default.createElement(Q.SuggestedMembersCheckboxes,{emails:a,toggleCheckboxCallback:this.checkboxCallback,suggestions:o,disabled:this.state.isMakingTransitionInfoRequest}))},p.prototype.renderPricingInformation=function(){var e=this.state,t=e.numRemainingLicenses,i=e.subChangePlan,s=e.subStatus,a=e.isMakingTransitionInfoRequest,o=e.isJustInTimeLicensingEnabled,r=this.props.pricingInformationClassName;return s&&i&&i.finalSubState.billingSchedule?a?n.default.createElement("div",{className:r},n.default.createElement(m.LoadingIndicator,{style:m.LoadingIndicator.LoadingIndicatorStyle.SPINNER})):t<0?n.default.createElement("div",{className:r},n.default.createElement(C.InviteAndBuyText,{className:"invite-modal__invite-and-buy-text u-font-meta",textColor:"faint",textSize:"standard",additionalLicenses:-1*t,isTrial:s.isOnTrial,nextBillingDate:s.formattedNextBillingDate,subChangePlan:i,isJustInTimeLicensingEnabled:o}),o?null:n.default.createElement("a",{href:"#",className:"invite-modal__update-billing-link",onClick:this.onBillingClick},N.intl.formatMessage({id:"tbFeQQ",defaultMessage:"Update billing"}))):null:null},Object.defineProperty(p.prototype,"isNCCT",{get:function(){var e=this.state,t=e.subStatus,i=e.ncctVariant;return!!t&&(t.isOnTrial&&A.Experiment(i).variantIn("V1","V2","V3","V4","V5","V6","V7","V8","V9","V10","V11","V12","V13"))},enumerable:!1,configurable:!0}),p.prototype.fetchSuggestions=function(){var e=this,t=w.Viewer.get_viewer().work_user;t&&(new K.UserApiV2Client).ns("team_experience").rpc("teammate_suggestions/list",void 0,{subjectUserId:t.id}).then((function(t){var i=t.recommended_members.members.slice(0,2);d.TeamsWebActionsLogger.log("admin_recommendations_shown_imm",{num_recommendations:i.length,suggest_id:t.suggest_id,origin:e.props.origin});for(var n=0,s=i;n<s.length;n++){var a=s[n];d.TeamsWebActionsLogger.log("admin_display_recommended_contact",{user_id:a.user_id,team_type:a.team_type,prediction_id:a.prediction_id,origin:"imm_recommendation"})}e.setState({suggestedMembers:i,suggestedMembersSuggestId:t.suggest_id})}))},p.isContactInvalid=function(e){return Boolean(!0===e.invalid||e.invitability_state&&j.InvitabilityWarnings.has(e.invitability_state))},p.isContactReinvite=function(e){return Boolean(e.invitability_state&&e.invitability_state===oe.InvitabilityState.REINVITE.toString())},p.countReinviteContacts=function(e){for(var i=0,n=0,s=e;n<s.length;n++){var a=s[n];t.InviteModal.isContactReinvite(a)&&i++}return i},p.countValidAndNonReinviteContacts=function(e){for(var i=0,n=0,s=e;n<s.length;n++){var a=s[n];t.InviteModal.isContactInvalid(a)||t.InviteModal.isContactReinvite(a)||i++}return i},p.prototype.getInviteCount=function(e){if(void 0!==this.props.inviteCount)return this.props.inviteCount;var i=this.state,n=i.emails,s=i.contacts;return void 0!==e?e.length:this.props.shouldAsyncValidateEmails?t.InviteModal.countValidAndNonReinviteContacts(s):n.length},Object.defineProperty(p.prototype,"inviteModalTitle",{get:function(){var e=this.props,t=e.isAfterLicenseReclaim,i=e.getTitle,n=this.state,s=n.isJustInTimeLicensingEnabled,a=n.numRemainingLicenses;return i?i(s,a):t?N.intl.formatMessage({id:"RwO5iU",defaultMessage:"Invite someone else to the team"}):N.intl.formatMessage({id:"/KqWDm",defaultMessage:"Invite members to your team"})},enumerable:!1,configurable:!0}),p.prototype.render=function(){var e=this,t=this.props,i=t.isOpen,s=t.isFirstTask,a=t.customClass,r=t.inviteLinkUrl,l=t.inviteLinkExpiredTs,c=t.inviteToken,d=t.nextInviteLinkUrl,u=t.csvImportLabel,g=t.onCSVImport,_=t.tieredAdmin,v=t.teamAvailableRoles,p=t.width,f=void 0===p?j.inviteModalWidth:p,b=t.ncctNoBillingInfo,h=t.isInviteLinkEnabled,I=t.getBody,M=t.evhMaxDays,L=t.isAfterLicenseReclaim,S=t.shouldNotShowAvailableLicenses,y=t.isMobileWeb,T=this.state,C=T.numRemainingLicenses,k=T.emails,A=T.memberList,w=T.showSidebar,x=T.sentEmails,R=T.isJustInTimeLicensingEnabled,O=this.showInviteLink(),P=this.inviteModalTitle,V=this.shouldRenderSendInviteAction||!O&&!L;if(s&&A.length){return n.default.createElement(J.FirstTaskInviteModal,{open:!!i,tieredAdmin:_,teamAvailableRoles:v||[],memberList:A,showSidebar:w,emails:k,sentEmails:x,handleOnClose:this.closeModal,onCSVImport:g,handleOnSubmit:this.onPrimaryActionClick,handleCSVImport:this.closeAndOpenCSVImportModal,renderInputForm:this.renderContactsTokenizer,renderPricingInfo:this.renderAltAction.bind(this),renderSubmitBtn:this.renderPrimaryAction,loggingExtras:this.defaultLoggingExtras,evhMaxDays:M,relaunchModal:function(t){return e.relaunchFirstTaskModal(t)},updateMemberList:function(t){return e.setState({memberList:t})},showImportCSV:!1,isMobileWeb:y,isInviteLinkEnabled:h})}var D=O?n.default.createElement(q.InviteLink,{numRemainingLicenses:C,inviteLinkUrl:r,inviteLinkExpiredTs:l,inviteToken:c,nextInviteLinkUrl:d,teamRoutes:this.apiClient.teamRoutes(),emails:k,onInviteLinkCreateStart:this.props.onInviteLinkCreateStart,onInviteLinkCreateEnd:this.props.onInviteLinkCreateEnd,onInviteLinkDelete:this.props.onInviteLinkDelete,onUpdateModal:this.props.onUpdateModal,isTrial:F.get(this.state.subStatus,"isOnTrial"),showAddLicenses:this.props.showAddLicenses,isNcct:this.isNCCT&&(null==b||b),isJustInTimeLicensingEnabled:R}):null,W=n.default.createElement("hr",{className:"invite-modal__invite_link_divider"}),U=n.default.createElement(n.default.Fragment,null,O&&n.default.createElement(n.default.Fragment,null,D,W),I&&this.getInviteCount(k)>0?I(R):this.renderForm(),this.props.linkToImportGsuiteContacts&&n.default.createElement(ee.ImportContactsLink,{launchImportModal:this.launchImportModal}),this.renderAltAction());return n.default.createElement(o.UtilityModal,{ariaLabel:N.intl.formatMessage({id:"TuViF7",defaultMessage:"Invite Members"}),className:"invite-modal "+a,onPrimaryAction:this.onPrimaryActionClick,onSecondaryAction:this.onSecondaryActionClick,open:!0,overlayClickClose:!0,primaryAction:this.state.isLoading?function(){return n.default.createElement(n.default.Fragment,null)}:this.renderPrimaryAction,secondaryAction:V?this.renderSecondaryAction:void 0,title:this.state.isLoading?"":P,width:f+"px",link:u,onLink:g?this.closeAndOpenCSVImportModal:void 0,overlayClassName:"file-viewer-modal-overlay"},this.state.isLoading&&n.default.createElement("div",{className:"invite-modal__loading-spinner"},n.default.createElement(m.LoadingIndicator,{style:m.LoadingIndicator.LoadingIndicatorStyle.DOTS})),!this.state.isLoading&&n.default.createElement(n.default.Fragment,null,n.default.createElement(B.UXAnalyticsModalTracking,{id:"invite-modal"}),n.default.createElement("div",{className:"invite-modal__content"},!0!==S&&n.default.createElement(E.AvailableLicensesText,{id:"invite-modal__form-license-msg",textColor:"standard",textSize:"standard",numInvitees:this.getInviteCount(),numRemainingLicenses:C,isSelfServe:this.state.isSelfServe,isReseller:this.state.isReseller,resellerContact:this.state.resellerContact,isNCCT:this.isNCCT,isJustInTimeLicensingEnabled:R}),U)))},p.defaultProps={isFirstTask:!1,experiments:{expTeamSuccessImportGsuiteMembers:"OFF"},inviteMessage:"",emails:[],pricingInformationClassName:"invite-modal__invite-and-buy--email-invite"},p})(n.default.Component);t.InviteModalView=re,t.InviteModal=T.requireCssWithComponent(re,["/static/css/spectrum/index.web-vflmHVRF-.css","/static/js/spectrum-sharing/index.web-vfl4PGIb_.css","/static/css/teams/admin/widgets/invite_modal/invite_modal-vfljKSIA3.css","/static/css/notify-vflHqdPvq.css","/static/css/dig-components/index.web-vflGJghcb.css"])}));
//# sourceMappingURL=invite_modal.min.js-vfl03084G.map